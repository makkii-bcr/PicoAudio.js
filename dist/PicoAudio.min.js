!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).PicoAudio=t()}(this,(function(){"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(t)}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var i=0;i<t.length;i++){var a=t[i];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function a(e,t,a){return t&&i(e.prototype,t),a&&i(e,a),e}function n(e){return(n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function r(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function o(e,t,i){return(o=r()?Reflect.construct:function(e,t,i){var a=[null];a.push.apply(a,t);var n=new(Function.bind.apply(e,a));return i&&s(n,i.prototype),n}).apply(null,arguments)}function u(e){var t="function"==typeof Map?new Map:void 0;return(u=function(e){if(null===e||(i=e,-1===Function.toString.call(i).indexOf("[native code]")))return e;var i;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,a)}function a(){return o(e,arguments,n(this).constructor)}return a.prototype=Object.create(e.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),s(a,e)})(e)}function c(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function l(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function m(e){var t=this;for(var i in this.debug=!1,this.isStarted=!1,this.isPlayed=!1,this.settings={masterVolume:1,generateVolume:.15,tempo:120,basePitch:440,resolution:480,isWebMIDI:!1,WebMIDIPortOutputs:null,WebMIDIPortOutput:null,WebMIDIPort:-1,WebMIDIPortSysEx:!0,isReverb:!0,reverbVolume:1.5,initReverb:10,isChorus:!0,chorusVolume:.5,isCC111:!0,loop:!1,isSkipBeginning:!1,isSkipEnding:!0,holdOnValue:64,maxPoly:-1,maxPercPoly:-1,isOfflineRendering:!1,isSameDrumSoundOverlap:!1},h(this,e,"debug"),this.settings)h(this.settings,e,i);this.events=[],this.trigger={isNoteTrigger:!0,play:function(){c(this,t)}.bind(this),stop:function(){c(this,t)}.bind(this),noteOn:function(){c(this,t)}.bind(this),noteOff:function(){c(this,t)}.bind(this),songEnd:function(){c(this,t)}.bind(this)},this.states={isPlaying:!1,startTime:0,stopTime:0,stopFuncs:[],webMIDIWaitState:null,webMIDIStopTime:0,playIndices:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],updateBufTime:100,updateBufMaxTime:350,updateIntervalTime:0,latencyLimitTime:0},this.hashedDataList=[],this.hashedMessageList=[],this.playData=null,this.channels=[],this.tempoTrack=[{timing:0,value:120},{timing:0,value:120}],this.cc111Time=-1,this.onSongEndListener=null;for(var a=0;a<17;a++)this.channels.push([0,0,1]);e&&e.audioContext&&this.init(e),"undefined"==typeof performance&&(window.performance={}),performance.now||(performance.now=function(){return c(this,t),Date.now()}.bind(this)),Number.MAX_SAFE_INTEGER||(Number.MAX_SAFE_INTEGER=9007199254740991)}function h(e,t,i){console.log(e,t,i,e[i],t[i]),t&&null!=t[i]&&e&&null!=e[i]&&(e[i]=t[i])}var p=function(){function e(){t(this,e)}return a(e,null,[{key:"resetSeed",value:function(){this.init=!0,this.x=123456789,this.y=362436069,this.z=521288629,this.w=8867512}},{key:"random",value:function(){this.init||this.resetSeed();var e=this.x^this.x<<11;this.x=this.y,this.y=this.z,this.z=this.w;var t=this.w=this.w^this.w>>>19^e^e>>>8;return t=Math.abs(t)/2147483648%2}}]),e}(),T=function(){function e(){t(this,e)}return a(e,null,[{key:"lerpWave",value:function(e,t){var i=e.getChannelData(0).length,a=t[0].length;if(i==a)for(var n=0;n<2;n++)for(var s=e.getChannelData(n),r=t[n],o=0;o<i;o++)s[o]=r[o];else for(var u=a/i,c=0;c<2;c++)for(var l=e.getChannelData(c),m=t[c],h=0;h<i;h++){var p=h*u,T=Math.trunc(p),f=(T+1)%a,g=p-T,v=m[T]*(1-g)+m[f]*g;l[h]=v}}}]),e}();function f(e){if(!this.isStarted){this.isStarted=!0;var t=e&&e.audioContext,i=e&&e.picoAudio,a=window.AudioContext||window.webkitAudioContext;this.context=t||new a,this.masterGainNode=this.context.createGain(),this.masterGainNode.gain.value=this.settings.masterVolume;var n=this.context.sampleRate,s=n>=48e3?48e3:n;if(i&&i.whitenoise)this.whitenoise=i.whitenoise;else{p.resetSeed();for(var r=1*n,o=1*s,u=[],c=0;c<2;c++){u.push(new Float32Array(o));for(var l=u[c],m=0;m<o;m++){var h=p.random();l[m]=2*h-1}}this.whitenoise=this.context.createBuffer(2,r,n),T.lerpWave(this.whitenoise,u)}if(i&&i.impulseResponse)this.impulseResponse=i.impulseResponse;else{p.resetSeed();for(var f=3.5*n,g=3.5*s,v=[],d=0;d<2;d++){v.push(new Float32Array(g));for(var b=v[d],y=0;y<g;y++){var A=(g-y)/g,V=y/s,k=(V<.03?0:A)*(V>=.03&&V<.031?2*A:A)*(V>=.04&&V<.042?1.5*A:A)*(V>=.05&&V<.054?1.25*A:A)*p.random()*.2*Math.pow(A-.03,4);b[y]=k}}this.impulseResponse=this.context.createBuffer(2,f,this.context.sampleRate),T.lerpWave(this.impulseResponse,v)}this.convolver=this.context.createConvolver(),this.convolver.buffer=this.impulseResponse,this.convolver.normalize=!0,this.convolverGainNode=this.context.createGain(),this.convolverGainNode.gain.value=this.settings.reverbVolume,this.convolver.connect(this.convolverGainNode),this.convolverGainNode.connect(this.masterGainNode),this.masterGainNode.connect(this.context.destination),this.chorusDelayNode=this.context.createDelay(),this.chorusGainNode=this.context.createGain(),this.chorusOscillator=this.context.createOscillator(),this.chorusLfoGainNode=this.context.createGain(),this.chorusDelayNode.delayTime.value=.025,this.chorusLfoGainNode.gain.value=.01,this.chorusOscillator.frequency.value=.05,this.chorusGainNode.gain.value=this.settings.chorusVolume,this.chorusOscillator.connect(this.chorusLfoGainNode),this.chorusLfoGainNode.connect(this.chorusDelayNode.delayTime),this.chorusDelayNode.connect(this.chorusGainNode),this.chorusGainNode.connect(this.masterGainNode),this.masterGainNode.connect(this.context.destination),this.chorusOscillator.start(0)}}function g(e){if(this.debug)var t=performance.now();if(this.states.isPlaying&&this.stop(),this.playData=e,this.settings.resolution=e.header.resolution,this.settings.tempo=e.tempo||120,this.tempoTrack=e.tempoTrack,this.cc111Time=e.cc111Time,this.firstNoteOnTiming=e.firstNoteOnTiming,this.lastNoteOffTiming=e.lastNoteOffTiming,this.firstNoteOnTime=e.firstNoteOnTime,this.lastNoteOffTime=e.lastNoteOffTime,this.initStatus(),this.debug){var i=performance.now();console.log("setData time",i-t)}return this}function v(e,t){if((!this.settings.isWebMIDI||null==this.states.webMIDIWaitState)&&(this.stop(e),this.states={isPlaying:!1,startTime:0,stopTime:0,stopFuncs:[],webMIDIWaitState:null,webMIDIStopTime:this.states.webMIDIStopTime,playIndices:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],updateBufTime:this.states.updateBufTime,updateBufMaxTime:this.states.updateBufMaxTime,updateIntervalTime:this.states.updateIntervalTime,latencyLimitTime:this.states.latencyLimitTime,noteOnAry:[],noteOffAry:[]},this.settings.isWebMIDI&&!t)){if(e)return;if(null==this.settings.WebMIDIPortOutput)return void this.startWebMIDI();if(this.settings.WebMIDIPortSysEx)this.settings.WebMIDIPortOutput.send([240,126,127,9,1,247]);else for(var i=0;i<16;i++)this.settings.WebMIDIPortOutput.send([192+i,0]),this.settings.WebMIDIPortOutput.send([224+i,0,64]),this.settings.WebMIDIPortOutput.send([176+i,100,0]),this.settings.WebMIDIPortOutput.send([176+i,101,0]),this.settings.WebMIDIPortOutput.send([176+i,6,2]),this.settings.WebMIDIPortOutput.send([176+i,100,1]),this.settings.WebMIDIPortOutput.send([176+i,96,0]),this.settings.WebMIDIPortOutput.send([176+i,97,64]),this.settings.WebMIDIPortOutput.send([176+i,7,100]),this.settings.WebMIDIPortOutput.send([176+i,10,64]),this.settings.WebMIDIPortOutput.send([176+i,11,127]),this.settings.WebMIDIPortOutput.send([176+i,98,0]),this.settings.WebMIDIPortOutput.send([176+i,99,0]),this.settings.WebMIDIPortOutput.send([176+i,122,0])}}var d=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(c,e);var i,o,u=(i=c,o=r(),function(){var e,t=n(i);if(o){var a=n(this).constructor;e=Reflect.construct(t,arguments,a)}else e=t.apply(this,arguments);return l(this,e)});function c(){return t(this,c),u.apply(this,arguments)}return a(c,null,[{key:"delete",value:function(e,t){t==e.length-1?e.pop():0==t?e.shift():e.splice(t,1)}}]),c}(u(Array)),b=function(){function e(){t(this,e)}return a(e,null,[{key:"getInt",value:function(e,t,i){for(var a=0,n=t;n<i;n++)a=(a<<8)+e[n];return a}},{key:"variableLengthToInt",value:function(e,t,i){for(var a=t,n=0;a<i-1&&e[a]>=128;)a<t+4&&(n=(n<<7)+(e[a]-128)),a++;return[n=(n<<7)+e[a],++a-t]}},{key:"chIndicesInsert",value:function(e,t,i,a,n){var s=t.indices;if(t.indicesLength>=4&&i<s[t.indicesFoot])for(;-1!=t.indicesCur;){if(i<s[t.indicesCur]){t.indicesCur==t.indicesHead?t.indicesHead=t.indicesLength:s[t.indicesPre+3]=t.indicesLength,s[t.indicesLength]=i,s[t.indicesLength+1]=n,s[t.indicesLength+2]=a,s[t.indicesLength+3]=t.indicesCur,t.indicesPre=t.indicesLength,t.indicesLength+=4;break}t.indicesPre=t.indicesCur,t.indicesCur=s[t.indicesCur+3]}else t.indicesLength>=4?s[t.indicesFoot+3]=t.indicesLength:t.indicesHead=0,t.indicesFoot=t.indicesLength,s[t.indicesLength]=i,s[t.indicesLength+1]=n,s[t.indicesLength+2]=a,s[t.indicesLength+3]=-1,t.indicesLength+=4}}]),e}(),y=function(){function e(){t(this,e)}return a(e,null,[{key:"init",value:function(e,t){this.updatePreTime=performance.now(),this.pPreTime=performance.now(),this.cPreTime=1e3*e.context.currentTime,this.pTimeSum=0,this.cTimeSum=0,this.cnt=0,this.initCurrentTime=t}},{key:"update",value:function(e){var t=this,i=e.context,a=e.settings,n=e.states,s=performance.now(),r=this.updatePreTime,o=this.pPreTime,u=this.cPreTime,l=this.pTimeSum,m=this.cTimeSum,h=this.cnt,p=s-r,T=s,f=1e3*i.currentTime;l+=T-o,m+=f-u,o=T,u=f;var g=l-m;if(n.latencyTime=g,g>=100?(n.latencyLimitTime+=g,m+=100):g<=-100?m=l:n.latencyLimitTime>0&&(n.latencyLimitTime-=.003*p,n.latencyLimitTime<0&&(n.latencyLimitTime=0)),n.updateIntervalTime=p,n.updateBufTime<p?n.updateBufTime=p:(n.updateBufMaxTime>350&&(n.updateBufMaxTime-=.002*n.updateBufMaxTime),n.updateBufTime<20&&(n.updateBufTime+=5e-4*n.updateBufTime),n.updateBufMaxTime>=10&&n.updateBufMaxTime<340&&(n.updateBufMaxTime+=.002*n.updateBufMaxTime)),n.updateBufTime>n.updateBufMaxTime){if(p>=900&&n.latencyLimitTime<=150)n.updateBufMaxTime+=p;else{var v=p-n.updateBufMaxTime;n.updateBufTime=n.updateBufMaxTime,n.updateBufMaxTime<10?(n.updateBufTime=n.updateBufMaxTime,n.updateBufMaxTime*=1.25):n.updateBufMaxTime+=v/2}n.updateBufMaxTime>1100&&(n.updateBufMaxTime=1100)}n.latencyLimitTime>150&&(m=l,n.latencyLimitTime-=5,n.latencyLimitTime>1e3&&(n.latencyLimitTime=1e3),n.updateBufMaxTime=1,n.updateBufTime=1,p=1);for(var d=0;d<16;d++){var y=e.playData.channels[d].notes,A=n.playIndices[d],V=function(){var s=this,r=y[A],o=0==h?t.initCurrentTime-n.startTime:i.currentTime-n.startTime;if(o>=r.stopTime)return"continue";if(0==h&&o>r.startTime+.05)return"continue";if(o+r.startTime<0)return"continue";if(o<r.startTime-n.updateBufTime/1e3)return"break";if(!a.isWebMIDI){if(n.stopFuncs.length>=350&&n.updateBufTime<1e3&&(n.updateBufTime=12,n.updateBufMaxTime=n.updateBufTime),-1!=a.maxPoly||-1!=a.maxPercPoly){var u=0,l=0;if(n.stopFuncs.forEach(function(e){c(this,s),e.note&&(9!=e.note.channel?r.start>=e.note.start&&r.start<e.note.stop&&u++:r.start==e.note.start&&l++)}.bind(this)),9!=r.channel&&u>=a.maxPoly||9==r.channel&&l>=a.maxPercPoly)return"continue"}var m=9!=r.channel?e.createNote(r):e.createPercussionNote(r);if(!m)return"continue";e.pushFunc({note:r,stopFunc:m})}n.noteOnAry.push(r)};e:for(;A<y.length;A++){switch(V()){case"continue":continue;case"break":break e}}n.playIndices[d]=A}if(this.checkNoteOn(e),this.checkNoteOff(e),a.isWebMIDI&&null!=a.WebMIDIPortOutput){for(var k=e.playData.messages,I=e.playData.smfData,R=n.playIndices[16];R<k.length;R++){var M=k[R],N=i.currentTime-n.startTime;if(!(N>M.time+1)){if(N<M.time-1)break;var w=M.smfPtrLen,O=M.smfPtr,P=M.time,S=I[O];if(255!=S)try{if(240==S||247==S){if(a.WebMIDIPortSysEx){var D=b.variableLengthToInt(I,O+1,O+1+4),x=O+1+D[1],E=x+D[0],W=new Uint8Array(1+D[0]);W[0]=S;for(var L=E-x,q=0;q<L;q++)W[q+1]=I[x+q];a.WebMIDIPortOutput.send(W,1e3*(P-i.currentTime+window.performance.now()/1e3+n.startTime))}}else{for(var B=[],G=0;G<w;G++)B.push(I[O+G]);a.WebMIDIPortOutput.send(B,1e3*(P-i.currentTime+window.performance.now()/1e3+n.startTime))}}catch(e){console.log(e,O,w,P,S)}}}n.playIndices[16]=R}h++,this.updatePreTime=s,this.pPreTime=o,this.cPreTime=u,this.pTimeSum=l,this.cTimeSum=m,this.cnt=h}},{key:"checkNoteOn",value:function(e){for(var t=e.context,i=e.trigger,a=e.states,n=e.states.noteOnAry,s=e.states.noteOffAry,r=0;r<n.length;r++){var o=n[r],u=t.currentTime-a.startTime;o.startTime-u<=0&&(d.delete(n,r),s.push(o),i.isNoteTrigger&&i.noteOn(o),e.fireEvent("noteOn",o),r--)}}},{key:"checkNoteOff",value:function(e){for(var t=e.context,i=e.trigger,a=e.states,n=e.states.noteOffAry,s=0;s<n.length;s++){var r=n[s],o=t.currentTime-a.startTime;(9!=r.channel&&r.stopTime-o<=0||9==r.channel&&r.drumStopTime-o<=0)&&(d.delete(n,s),e.clearFunc("note",r),i.isNoteTrigger&&i.noteOff(r),e.fireEvent("noteOff",r),s--)}}}]),e}();function A(e){var t=this,i=this.context,a=this.settings,n=this.trigger,s=this.states;if(!s.isPlaying){if(a.isWebMIDI&&!e){if("completed"!=s.webMIDIWaitState){if("waiting"!=s.webMIDIWaitState){s.webMIDIWaitState="waiting";var r=1e3-1e3*(i.currentTime-s.webMIDIStopTime);0==s.webMIDIStopTime&&(r=1e3),setTimeout(function(){c(this,t),s.webMIDIWaitState="completed",s.isPlaying=!1,this.play()}.bind(this),r)}return}s.webMIDIWaitState=null}var o,u=i.currentTime;if(this.isPlayed=!0,s.isPlaying=!0,s.startTime=s.startTime||s.stopTime?s.startTime+u-s.stopTime:u,s.stopFuncs=[],a.isSkipBeginning){var l=this.firstNoteOnTime;-s.startTime+u<l&&this.setStartTime(l+s.startTime-u)}var m=function(){var e=this;c(this,t),this.clearFunc("rootTimeout",o),(a.isCC111&&-1!=this.cc111Time?this.lastNoteOffTime:this.getTime(Number.MAX_SAFE_INTEGER))-i.currentTime+s.startTime<=0?(n.songEnd(),this.onSongEnd(),this.fireEvent("songEnd")):(o=setTimeout(m,1),this.pushFunc({rootTimeout:o,stopFunc:function(){c(this,e),clearTimeout(o)}.bind(this)}))}.bind(this),h=1e3*((a.isCC111&&-1!=this.cc111Time?this.lastNoteOffTime:this.getTime(Number.MAX_SAFE_INTEGER))-i.currentTime+s.startTime);o=setTimeout(m,h),this.pushFunc({rootTimeout:o,stopFunc:function(){c(this,t),clearTimeout(o)}.bind(this)}),n.play(),this.fireEvent("play"),y.init(this,u);var p=setInterval(function(){c(this,t),y.update(this)}.bind(this),1);this.pushFunc({rootTimeout:p,stopFunc:function(){c(this,t),clearInterval(p)}.bind(this)})}}function V(e){var t=this,i=this.states;if(0!=i.isPlaying){if(i.isPlaying=!1,i.stopTime=this.context.currentTime,i.stopFuncs.forEach(function(e){c(this,t),e.stopFunc()}.bind(this)),i.stopFuncs=[],i.playIndices.forEach(function(e,i,a){c(this,t),a[i]=0}.bind(this)),i.noteOnAry=[],i.noteOffAry=[],this.settings.isWebMIDI){if(e)return;if(null==this.settings.WebMIDIPortOutput)return;i.webMIDIStopTime=this.context.currentTime,setTimeout(function(){c(this,t);for(var e=0;e<16;e++)this.settings.WebMIDIPortOutput.send([176+e,120,0])}.bind(this),1e3)}this.trigger.stop(),this.fireEvent("stop")}}function k(e,t,i,a,n){var s=this,r=this.settings,o=this.context,u=this.states.startTime,l=a?0:e.channel||0,m=e.velocity*Number(a?1:null!=this.channels[l][2]?this.channels[l][2]:1)*r.generateVolume,h=!0;if(m<=0)return{isGainValueZero:!0};var p=m*((e.expression?e.expression[0].value:100)/127),T=o.createGain();if(T.gain.value=p,i?e.expression&&e.expression.forEach(function(e){c(this,s);var t=m*(e.value/127);t>0&&(h=!1),T.gain.setValueAtTime(t,e.time+u)}.bind(this)):p>0&&(h=!1),h)return{isGainValueZero:!0};var f=e.startTime+u,g=e.stopTime+u,v=r.basePitch*Math.pow(Math.pow(2,1/12),(e.pitch||69)-69),d=t?o.createBufferSource():o.createOscillator(),b=o.createStereoPanner?o.createStereoPanner():o.createPanner?o.createPanner():{pan:{setValueAtTime:function(){c(this,s)}.bind(this)}},y=o.createGain(),A=o.createGain();t?(d.loop=!0,d.buffer=this.whitenoise):(d.type=e.type||"sine",d.detune.value=0,d.frequency.value=v,e.pitchBend&&e.pitchBend.forEach(function(t){c(this,s),d.frequency.setValueAtTime(r.basePitch*Math.pow(Math.pow(2,1/12),e.pitch-69+t.value),t.time+u)}.bind(this)));var V,k,R=e.pan&&64!=e.pan[0].value?e.pan[0].value/127*2-1:0;if(function(e,t,i){if(e.createStereoPanner)i>1&&(i=1),t.pan.value=i;else if(e.createPanner){var a=I(i);t.panningModel="equalpower",t.setPosition(a.x,a.y,a.z)}}(o,b,R),o.createStereoPanner||o.createPanner){var M=!0;if(o.createStereoPanner)e.pan&&e.pan.forEach(function(e){if(c(this,s),M)M=!1;else{var t=64==e.value?0:e.value/127*2-1;t>1&&(t=1),b.pan.setValueAtTime(t,e.time+u)}}.bind(this));else if(o.createPanner)if(b.positionX){var N=!0;e.pan&&e.pan.forEach(function(e){if(c(this,s),N)N=!1;else{var t=I(64==e.value?0:e.value/127*2-1);b.positionX.setValueAtTime(t.x,e.time+u),b.positionY.setValueAtTime(t.y,e.time+u),b.positionZ.setValueAtTime(t.z,e.time+u)}}.bind(this))}else e.pan&&e.pan.forEach(function(e){var t=this;if(c(this,s),M)M=!1;else{var i=setTimeout(function(){c(this,t),this.clearFunc("pan",i);var a=64==e.value?0:e.value/127*2-1;a>1&&(a=1);var n=I(a);b.setPosition(n.x,n.y,n.z)}.bind(this),1e3*(e.time+u-o.currentTime));this.pushFunc({pan:i,stopFunc:function(){c(this,t),clearTimeout(i)}.bind(this)})}}.bind(this));d.connect(b),b.connect(T)}else d.connect(T);if(T.connect(y),y.connect(A),A.connect(this.masterGainNode),this.masterGainNode.connect(o.destination),!t&&e.modulation&&(e.modulation.length>=2||e.modulation[0].value>0)){V=o.createOscillator(),k=o.createGain();var w=!0;e.modulation&&e.modulation.forEach(function(e){if(c(this,s),w)w=!1;else{var t=e.value/127;t>1&&(t=1),k.gain.setValueAtTime(10*v/440*t,e.time+u)}}.bind(this));var O=e.modulation?e.modulation[0].value/127:0;O>1&&(O=1),k.gain.value=10*v/440*O,V.frequency.value=6,V.connect(k),k.connect(d.frequency)}if(this.settings.isReverb&&e.reverb&&(e.reverb.length>=2||e.reverb[0].value>0)){var P=this.convolver,S=o.createGain(),D=!0;e.reverb&&e.reverb.forEach(function(e){if(c(this,s),D)D=!1;else{var t=e.value/127;t>1&&(t=1),S.gain.setValueAtTime(t,e.time+u)}}.bind(this));var x=e.reverb?e.reverb[0].value/127:0;x>1&&(x=1),S.gain.value=x,y.connect(A),A.connect(S),S.connect(P)}if(this.settings.isChorus&&e.chorus&&(e.chorus.length>=2||e.chorus[0].value>0)){var E=this.chorusDelayNode,W=o.createGain(),L=!0;e.chorus&&e.chorus.forEach(function(e){if(c(this,s),L)L=!1;else{var t=e.value/127;t>1&&(t=1),W.gain.setValueAtTime(t,e.time+u)}}.bind(this));var q=e.chorus?e.chorus[0].value/127:0;q>1&&(q=1),W.gain.value=q,y.connect(A),A.connect(W),W.connect(E)}return V&&(V.start(f),this.stopAudioNode(V,g,k)),d.start(f),t||a||n||this.stopAudioNode(d,g,A),{start:f,stop:g,pitch:v,channel:l,velocity:m,oscillator:d,panNode:b,gainNode:y,stopGainNode:A,isGainValueZero:!1}}function I(e){e>1&&(e=1);var t={},i=90*e;return t.x=Math.sin(i*(Math.PI/180)),t.y=0,t.z=-Math.cos(i*(Math.PI/180)),t}function R(e){var t=this,i=this.createBaseNote(e,!1,!0,!1,!0);if(i.isGainValueZero)return null;var a,n=i.oscillator,s=i.gainNode,r=i.stopGainNode,o=!1,u=!1;switch(1e3*this.channels[i.channel][0]||e.instrument){case 1e3:case 6:case 15:case 24:case 26:case 46:case 50:case 51:case 52:case 53:case 54:case 82:case 85:case 86:n.type="sine",s.gain.value*=1.5;break;case 2e3:case 4:case 12:case 13:case 16:case 19:case 20:case 32:case 34:case 45:case 48:case 49:case 55:case 56:case 57:case 61:case 62:case 63:case 71:case 72:case 73:case 74:case 75:case 76:case 77:case 78:case 79:case 80:case 84:n.type="square",s.gain.value*=.8;break;case 3e3:case 0:case 1:case 2:case 3:case 7:case 17:case 18:case 21:case 22:case 23:case 27:case 28:case 29:case 30:case 36:case 37:case 38:case 39:case 40:case 41:case 42:case 43:case 44:case 47:case 59:case 64:case 65:case 66:case 67:case 68:case 69:case 70:case 87:n.type="sawtooth";break;case 4e3:case 8:case 9:case 10:case 11:case 14:case 25:case 31:case 33:case 35:case 58:case 60:case 83:case 88:case 89:case 90:case 91:case 92:case 93:case 94:case 95:n.type="triangle",s.gain.value*=1.5;break;default:n.type="square"}switch(("sine"==n.type||"triangle"==n.type)&&!o&&i.stop-i.start>.01&&(u=!0),this.channels[i.channel][1]/10||e.instrument){case.2:case 12:case 13:case 45:case 55:o=!0,s.gain.value*=1.1,s.gain.setValueAtTime(s.gain.value,i.start),s.gain.linearRampToValueAtTime(0,i.start+.2),this.stopAudioNode(n,i.start+.2,r);break;case.3:case 0:case 1:case 2:case 3:case 6:case 9:case 11:case 14:case 15:case 32:case 36:case 37:case 46:case 47:s.gain.value*=1.1;var l=(128-e.pitch)/128;s.gain.setValueAtTime(s.gain.value,i.start),s.gain.linearRampToValueAtTime(.85*s.gain.value,i.start+l*l/8),s.gain.linearRampToValueAtTime(.8*s.gain.value,i.start+l*l/4),s.gain.setTargetAtTime(0,i.start+l*l/4,5*l*l),this.stopAudioNode(n,i.stop,r,u);break;case.4:case 24:case 25:case 26:case 27:case 28:case 29:case 30:case 31:case 34:s.gain.value*=1.1,s.gain.setValueAtTime(s.gain.value,i.start),s.gain.linearRampToValueAtTime(0,i.start+1+4*i.velocity),this.stopAudioNode(n,i.stop,r,u);break;case.5:case 4:case 5:case 7:case 8:case 10:case 33:case 35:s.gain.value*=1,s.gain.setValueAtTime(s.gain.value,i.start),s.gain.linearRampToValueAtTime(.95*s.gain.value,i.start+.1),s.gain.setValueAtTime(.95*s.gain.value,i.start+.1),s.gain.linearRampToValueAtTime(0,i.start+2+10*i.velocity),this.stopAudioNode(n,i.stop,r,u);break;case 119:if(s.gain.value=0,this.stopAudioNode(n,i.stop,r,u),(a=this.createBaseNote(e,!0,!0)).isGainValueZero)break;a.oscillator.playbackRate.setValueAtTime((e.pitch+1)/128,i.start),a.gainNode.gain.setValueAtTime(0,i.start),a.gainNode.gain.linearRampToValueAtTime(1.3,i.start+2),this.stopAudioNode(a.oscillator,i.stop,a.stopGainNode);break;default:s.gain.value*=1.1,s.gain.setValueAtTime(s.gain.value,i.start),this.stopAudioNode(n,i.stop,r,u)}return function(){c(this,t),this.stopAudioNode(n,0,r,!0),a&&a.oscillator&&this.stopAudioNode(a.oscillator,0,a.stopGainNode,!0)}.bind(this)}function M(e){var t=this,i=this.createBaseNote(e,!0,!1);if(i.isGainValueZero)return null;var a=i.oscillator,n=i.gainNode,s=i.stopGainNode,r=i.start,o=this.createBaseNote(e,!1,!1,!0),u=o.oscillator,l=o.gainNode,m=o.stopGainNode,h=e.nextSameNoteOnInterval;r<this.context.currentTime&&(r=this.context.currentTime);var p=0,T=0;switch(e.pitch){case 35:case 36:n.gain.value=.6,a.playbackRate.value=.02,p=.07,l.gain.value=1.1,u.frequency.setValueAtTime(120,r),u.frequency.linearRampToValueAtTime(50,r+.07),T=.07;break;case 38:case 40:a.playbackRate.value=.7,p=.05,l.gain.setValueAtTime(.8,r),l.gain.linearRampToValueAtTime(0,r+.05),u.frequency.setValueAtTime(300,r),u.frequency.linearRampToValueAtTime(200,r+.05),T=.05;break;case 41:case 43:case 45:case 47:case 48:case 50:a.playbackRate.value=.01,p=.1,u.type="square",l.gain.setValueAtTime(1,r),l.gain.linearRampToValueAtTime(.01,r+.1),u.frequency.setValueAtTime(150+20*(e.pitch-40),r),u.frequency.linearRampToValueAtTime(50+20*(e.pitch-40),r+.1),T=.1;break;case 42:case 44:a.playbackRate.value=1.5,p=.02,T=0;break;case 46:a.playbackRate.value=1.5,p=.3,n.gain.setValueAtTime(.9,r),n.gain.linearRampToValueAtTime(0,r+.3),T=0;break;case 49:case 52:case 53:case 55:case 57:a.playbackRate.value=1.2,p=.5,n.gain.setValueAtTime(1,r),n.gain.linearRampToValueAtTime(0,r+.5),T=0;break;case 51:a.playbackRate.value=1.1,p=.4,n.gain.setValueAtTime(.8,r),n.gain.linearRampToValueAtTime(0,r+.4),T=0;break;case 59:a.playbackRate.value=1.8,p=.3,n.gain.setValueAtTime(.5,r),n.gain.linearRampToValueAtTime(0,r+.3),T=0;break;case 60:case 61:a.playbackRate.value=.03,p=.03,l.gain.setValueAtTime(.8,r),l.gain.linearRampToValueAtTime(0,r+.1),u.frequency.setValueAtTime(400-40*(e.pitch-60),r),u.frequency.linearRampToValueAtTime(450-40*(e.pitch-60),r+.1),T=.1;break;case 62:a.playbackRate.value=.03,p=.03,l.gain.setValueAtTime(1,r),l.gain.linearRampToValueAtTime(0,r+.03),u.frequency.setValueAtTime(200,r),u.frequency.linearRampToValueAtTime(250,r+.03),T=.03;break;case 63:case 64:a.playbackRate.value=.03,p=.03,l.gain.setValueAtTime(1,r),l.gain.linearRampToValueAtTime(0,r+.1),u.frequency.setValueAtTime(200-30*(e.pitch-63),r),u.frequency.linearRampToValueAtTime(250-30*(e.pitch-63),r+.1),T=.1;break;case 56:case 75:a.playbackRate.value=.01,p=.1,l.gain.setValueAtTime(1,r),l.gain.linearRampToValueAtTime(0,r+.1),u.frequency.setValueAtTime(1e3+48*(e.pitch-56),r),T=.1;break;case 80:a.playbackRate.value=5,n.gain.setValueAtTime(.5,r),n.gain.linearRampToValueAtTime(0,r+.2),p=.05,u.type="triangle",l.gain.setValueAtTime(.7,r),l.gain.linearRampToValueAtTime(0,r+.2),u.frequency.setValueAtTime(6e3,r),T=.05;break;case 81:a.playbackRate.value=5,n.gain.setValueAtTime(.9,r),n.gain.linearRampToValueAtTime(0,r+.5),p=.5,u.type="triangle",l.gain.setValueAtTime(.8,r),l.gain.linearRampToValueAtTime(0,r+.3),u.frequency.setValueAtTime(6e3,r),T=.3;break;case 37:a.playbackRate.value=.26,n.gain.setValueAtTime(1.5,r),n.gain.linearRampToValueAtTime(0,r+.041),p=.041,u.frequency.setValueAtTime(330,r),u.frequency.linearRampToValueAtTime(120,r+.02),l.gain.setValueAtTime(1,r),l.gain.linearRampToValueAtTime(0,r+.02),T=.02;break;case 39:a.playbackRate.value=.5,n.gain.setValueAtTime(1.3,r),n.gain.linearRampToValueAtTime(0,r+.01),n.gain.setValueAtTime(1.3,r+.0101),n.gain.linearRampToValueAtTime(0,r+.02),n.gain.setValueAtTime(1.3,r+.0201),n.gain.linearRampToValueAtTime(0,r+.09),p=.09,u.type="triangle",u.frequency.setValueAtTime(180,r),l.gain.setValueAtTime(.8,r),l.gain.linearRampToValueAtTime(0,r+.01),l.gain.setValueAtTime(.8,r+.0101),l.gain.linearRampToValueAtTime(0,r+.02),l.gain.setValueAtTime(.8,r+.0201),l.gain.linearRampToValueAtTime(0,r+.03),T=.11;break;case 54:a.playbackRate.setValueAtTime(1,r);var f=54==e.pitch?1:.4,g=54==e.pitch?.01:0;n.gain.setValueAtTime(1*f/2,r),n.gain.linearRampToValueAtTime(1*f,r+g),n.gain.setTargetAtTime(0,r+g,.05),p=.3,u.frequency.setValueAtTime(54==e.pitch?6e3:495,r),f=54==e.pitch?1:2,l.gain.setValueAtTime(1*f/2,r),l.gain.linearRampToValueAtTime(1*f,r+g),l.gain.setTargetAtTime(0,r+g,.05),T=.3;break;case 58:a.playbackRate.setValueAtTime(.6,r),a.playbackRate.linearRampToValueAtTime(1,r+.8);n.gain.setValueAtTime(1.5,r),l.gain.setValueAtTime(.5,r);for(var v=0;v<40;v++)n.gain.linearRampToValueAtTime(.1*(40-v)/40,r+v/40*.8),n.gain.linearRampToValueAtTime(1.5*(40-(v+1))/40,r+(v+.99)/40*.8),l.gain.linearRampToValueAtTime(.025*(40-v)/40,r+v/40*.8),l.gain.linearRampToValueAtTime(.25*(40-(v+1))/40,r+(v+.99)/40*.8);n.gain.linearRampToValueAtTime(0,r+.8),l.gain.linearRampToValueAtTime(0,r+.8),p=.8,u.type="triangle",u.frequency.setValueAtTime(1e3,r),T=.8;break;case 65:case 66:var d=65==e.pitch?.22:.25;a.playbackRate.setValueAtTime(65==e.pitch?.25:.22,r),a.playbackRate.linearRampToValueAtTime(65==e.pitch?.2:.18,r+d),n.gain.setValueAtTime(1.3,r),n.gain.linearRampToValueAtTime(.2,r+d/3.5),n.gain.linearRampToValueAtTime(0,r+d),p=d,u.type="triangle",u.frequency.setValueAtTime(65==e.pitch?203.3:145.52,r),u.frequency.linearRampToValueAtTime(65==e.pitch?190:136,r+.1),l.gain.setValueAtTime(3.2,r),l.gain.setTargetAtTime(0,r,.08),T=1;break;case 67:case 68:a.playbackRate.value=1,n.gain.setValueAtTime(.5,r),n.gain.linearRampToValueAtTime(.1,r+.02),n.gain.linearRampToValueAtTime(0,r+.08),p=.08,u.type="triangle",u.frequency.setValueAtTime(67==e.pitch?1430:1055,r),l.gain.setValueAtTime(2,r),l.gain.setTargetAtTime(0,r,.06),T=.75;break;case 69:a.playbackRate.value=1,n.gain.setValueAtTime(.3,r),n.gain.linearRampToValueAtTime(.8,r+.03),n.gain.linearRampToValueAtTime(0,r+.08),p=.08,l.gain.value=0,T=0;break;case 70:a.playbackRate.value=1,n.gain.setValueAtTime(1.2,r),n.gain.linearRampToValueAtTime(0,r+.06),p=.06,l.gain.value=0,T=0;break;case 71:case 72:n.gain.value=0,p=0;var b=71==e.pitch?.07:.4;u.type="triangle",u.frequency.setValueAtTime(71==e.pitch?2408:2105,r),l.gain.setValueAtTime(0,r);for(var y=0;y<74*b;y++)l.gain.linearRampToValueAtTime(2.5,r+(y+.2)/75),l.gain.linearRampToValueAtTime(.5,r+(y+.9)/75);l.gain.linearRampToValueAtTime(0,r+b),T=b;break;case 73:case 74:var A=73==e.pitch?.05:.35;a.playbackRate.setValueAtTime((e.pitch,.2),r),a.playbackRate.linearRampToValueAtTime(73==e.pitch?.7:.5,r+A),n.gain.value=.2;for(var V=0;V<100*A;V++)n.gain.setValueAtTime(.4,r+V/100),n.gain.setValueAtTime(.9,r+(V+.7)/100);p=A,l.gain.value=0,T=0;break;case 76:case 77:a.playbackRate.value=.1,n.gain.setValueAtTime(1.2,r),n.gain.linearRampToValueAtTime(0,r+.015),p=.015,u.frequency.setValueAtTime(76==e.pitch?800:600,r),l.gain.setValueAtTime(0,r),l.gain.linearRampToValueAtTime(3,r+.005),l.gain.setTargetAtTime(0,r+.005,.02),T=.2;break;case 78:case 79:n.gain.value=0,p=0;var k=78==e.pitch?750:270;u.frequency.setValueAtTime(k,r),u.frequency.linearRampToValueAtTime(k,r+.06),78==e.pitch&&u.frequency.linearRampToValueAtTime(.9*k,r+.18),l.gain.setValueAtTime(0,r),l.gain.linearRampToValueAtTime(1.5,r+.005),l.gain.linearRampToValueAtTime(.5,r+.02),l.gain.linearRampToValueAtTime(3,r+.04),l.gain.linearRampToValueAtTime(2,r+.135),l.gain.linearRampToValueAtTime(0,r+.18),T=.18;break;case 27:a.playbackRate.value=1,n.gain.setValueAtTime(1,r),n.gain.linearRampToValueAtTime(0,r+.002),p=.002,u.frequency.setValueAtTime(1500,r),u.frequency.linearRampToValueAtTime(280,r+.015),u.frequency.linearRampToValueAtTime(0,r+.07),l.gain.setValueAtTime(1.9,r),l.gain.linearRampToValueAtTime(0,r+.07),T=.07;break;case 28:a.playbackRate.value=1,n.gain.setValueAtTime(1.3,r),n.gain.linearRampToValueAtTime(0,r+.01),n.gain.setValueAtTime(1.1,r+.0101),n.gain.linearRampToValueAtTime(0,r+.02),n.gain.setValueAtTime(.9,r+.0201),n.gain.setTargetAtTime(0,r+.0201,.03),p=.2,l.gain.value=0,T=0;break;case 29:case 30:var I=29==e.pitch?.05:.07,R=29==e.pitch?.06:.09,M=29==e.pitch?.07:.11,N=29==e.pitch?.1:.15,w=29==e.pitch?.25:.4,O=29==e.pitch?.1:.06,P=29==e.pitch?.3:.2,S=29==e.pitch?.18:.12;a.playbackRate.setValueAtTime(O,r),a.playbackRate.linearRampToValueAtTime(P,r+I),a.playbackRate.linearRampToValueAtTime(0,r+R),a.playbackRate.linearRampToValueAtTime(P,r+M),a.playbackRate.linearRampToValueAtTime(S,r+N),a.playbackRate.linearRampToValueAtTime(0,r+w),n.gain.setValueAtTime(0,r),n.gain.linearRampToValueAtTime(.4,r+I),n.gain.linearRampToValueAtTime(.1,r+M),n.gain.linearRampToValueAtTime(.3,r+N),n.gain.linearRampToValueAtTime(0,r+w),p=w;var D=29==e.pitch?500:400,x=29==e.pitch?1950:1200,E=29==e.pitch?430:250;u.frequency.setValueAtTime(D,r),u.frequency.linearRampToValueAtTime(x,r+I),u.frequency.linearRampToValueAtTime(0,r+R),u.frequency.linearRampToValueAtTime(x,r+M),u.frequency.linearRampToValueAtTime(E,r+N),u.frequency.linearRampToValueAtTime(0,r+w),l.gain.setValueAtTime(0,r),l.gain.linearRampToValueAtTime(.7,r+I),l.gain.linearRampToValueAtTime(.2,r+M),l.gain.linearRampToValueAtTime(.6,r+N),l.gain.linearRampToValueAtTime(0,r+w),T=w;break;case 31:a.playbackRate.setValueAtTime(.4,r),a.playbackRate.linearRampToValueAtTime(.5,r+.015),n.gain.setValueAtTime(1.2,r),n.gain.setTargetAtTime(0,r,.035),p=.3,u.frequency.setValueAtTime(3140,r),l.gain.setValueAtTime(1.2,r),l.gain.setTargetAtTime(0,r,.012),T=.3;break;case 32:n.gain.value=0,p=0,u.type="square",u.frequency.setValueAtTime(333,r),l.gain.setValueAtTime(0,r),l.gain.linearRampToValueAtTime(4,r+.0016),l.gain.linearRampToValueAtTime(0,r+.0032),T=.0032;break;case 33:case 34:a.playbackRate.setValueAtTime(.17,r),a.playbackRate.linearRampToValueAtTime(.22,r+.01),n.gain.setValueAtTime(1.5,r),n.gain.setTargetAtTime(0,r,.015),p=.3,34==e.pitch?(u.frequency.setValueAtTime(2040,r),l.gain.setValueAtTime(1,r),l.gain.setTargetAtTime(0,r,.12),T=1.1):(l.gain.value=0,T=0);break;case 82:a.playbackRate.value=1,n.gain.setValueAtTime(.5,r),n.gain.linearRampToValueAtTime(1,r+.02),n.gain.linearRampToValueAtTime(0,r+.07),p=.07,l.gain.value=0,T=0;break;case 83:a.playbackRate.value=1,n.gain.setValueAtTime(0,r),n.gain.linearRampToValueAtTime(1.2,r+.015),n.gain.setTargetAtTime(0,r+.015,.06),p=.5,u.type="triangle",u.frequency.setValueAtTime(2709,r),u.frequency.linearRampToValueAtTime(2657,r+.3),l.gain.setValueAtTime(0,r),l.gain.linearRampToValueAtTime(.7,r+.025),l.gain.setTargetAtTime(0,r+.025,.07),T=.5;break;case 84:a.playbackRate.value=1;for(var W=0;W<28;W++)n.gain.setValueAtTime(.1,r+W/24*.45),n.gain.setTargetAtTime(0,r+W/24*.45,.01),u.frequency.setValueAtTime(1380*(1+W/24),r+W/24*.45),l.gain.setValueAtTime(1*(.2+W/24),r+W/24*.45),l.gain.setTargetAtTime(0,r+W/24*.45,27==W?.2:.01);p=.5,T=1.5;break;case 85:a.playbackRate.setValueAtTime(.35,r),n.gain.setValueAtTime(1.3,r),n.gain.setTargetAtTime(0,r,.01),p=.1,u.frequency.setValueAtTime(1730,r),l.gain.setValueAtTime(.5,r),l.gain.setTargetAtTime(0,r,.01),T=.1;break;case 86:case 87:a.playbackRate.setValueAtTime(.02,r),a.playbackRate.linearRampToValueAtTime(.015,r+.5),n.gain.setValueAtTime(0,r),n.gain.linearRampToValueAtTime(2,r+.005),n.gain.setTargetAtTime(0,r+.005,86==e.pitch?.03:.06),p=.5,u.frequency.setValueAtTime(88,r),u.frequency.linearRampToValueAtTime(86,r+.3),l.gain.setValueAtTime(2.5,r),l.gain.setTargetAtTime(0,r,86==e.pitch?.1:.3),T=86==e.pitch?.5:1.5;break;default:a.playbackRate.value=e.pitch/69*2,p=.05,T=0}return this.settings.isSameDrumSoundOverlap||-1==h||(p>h&&(p=h),T>h&&(T=h)),this.stopAudioNode(a,r+p,s),this.stopAudioNode(u,r+T,m),e.drumStopTime=e.startTime+(p>=T?p:T),function(){c(this,t),this.stopAudioNode(a,0,s,!0),this.stopAudioNode(u,0,m,!0)}.bind(this)}function N(e,t,i,a){var n=t-.005,s=t;t<=this.context.currentTime&&(a?(n=this.context.currentTime,s=this.context.currentTime+.005):s=this.context.currentTime);try{a?(e.stop(s),i.gain.cancelScheduledValues(0),i.gain.setValueAtTime(1,n),i.gain.linearRampToValueAtTime(0,s)):e.stop(s)}catch(e){i.gain.cancelScheduledValues(0),a?(i.gain.setValueAtTime(1,n),i.gain.linearRampToValueAtTime(0,s)):i.gain.setValueAtTime(0,s)}}function w(e){(e.note||e.rootTimeout||e.pan||this.trigger.isNoteTrigger)&&this.states.stopFuncs.push(e)}function O(e,t){var i=this;("note"==e||"rootTimeout"==e||"pan"==e||this.trigger.isNoteTrigger)&&this.states.stopFuncs.some(function(a,n,s){if(c(this,i),a[e]==t)return d.delete(s,n),!0}.bind(this))}function P(e){var t=-1;if(this.tempoTrack&&this.tempoTrack.length>=1){if(e>=this.tempoTrack[this.tempoTrack.length-1].timing)return this.tempoTrack[this.tempoTrack.length-1].time;for(var i=0,a=this.tempoTrack.length-1;;){t=Math.floor(i+(a-i)/2);var n=this.tempoTrack[t].timing;if(e<n)a=t-1;else{if(!(e>n))break;i=t+1}if(i>a){e<n&&t--;break}}}var s=0,r=0,o=120;if(t>=0){var u=this.tempoTrack[t];s=u.time,r=u.timing,o=u.value}return s+=60/o/this.settings.resolution*(e-r)}function S(e){var t=-1;if(this.tempoTrack&&this.tempoTrack.length>=1){if(e>=this.tempoTrack[this.tempoTrack.length-1].time)return this.tempoTrack[this.tempoTrack.length-1].timing;for(var i=0,a=this.tempoTrack.length-1;;){t=Math.floor(i+(a-i)/2);var n=this.tempoTrack[t].time;if(e<n)a=t-1;else{if(!(e>n))break;i=t+1}if(i>a){e<n&&t--;break}}}var s=0,r=0,o=120;if(t>=0){var u=this.tempoTrack[t];s=u.time,r=u.timing,o=u.value}return r+=(e-s)/(60/o/this.settings.resolution)}function D(e){var t=e.smf,i=4,a={};a.size=b.getInt(t,4,8),a.format=t[9],a.trackcount=b.getInt(t,10,12),a.timemanage=t[12],a.resolution=b.getInt(t,12,14),i+=4+a.size;for(var n=[],s=this.settings.isWebMIDI?17:16,r=0;r<s;r++){var o={};n.push(o),o.indices=[],o.indicesLength=0,o.indicesHead=-1,o.indicesFoot=0,o.indicesCur=0,o.indicesPre=0,o.notes=[]}return e.p=i,e.header=a,e.channels=n,e}function x(e){for(var t=e.smf,i=e.p,a=e.header,n=e.channels,s=[],r=[],o=0,u=0;u<a.trackcount;u++){if(77!=t[i]||84!=t[i+1]||114!=t[i+2]||107!=t[i+3])return"Irregular SMF.";var c=(i+=4)+4+b.getInt(t,i,i+4);i+=4;for(var l=0,m=120,h=0,p=0,T=1,f=void 0;i<c;){if(null!=T){var g=b.variableLengthToInt(t,i,i+5);l+=f=g[0],i+=g[1]}var v=i;switch(t[i]>>4){case 8:case 9:case 10:case 11:case 14:var d=n[15&(T=t[i])];b.chIndicesInsert(this,d,l,i,3),i+=3;break;case 12:case 13:var y=n[15&(T=t[i])];b.chIndicesInsert(this,y,l,i,2),i+=2;break;case 15:switch(t[i]){case 240:case 247:var A=b.variableLengthToInt(t,i+1,i+1+4);if(A[0]>=7&&127==t[i+2]&&127==t[i+3]&&4==t[i+4]&&1==t[i+5])for(var V=0;V<16;V++){var k=n[V];b.chIndicesInsert(this,k,l,i,A[0])}i+=1+A[1]+A[0];break;case 241:i+=2;break;case 242:i+=3;break;case 243:i+=2;break;case 246:case 248:case 250:case 251:case 252:case 254:i+=1;break;case 255:switch(t[i+1]){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 32:break;case 47:l+=(this.settings.isSkipEnding?0:a.resolution)-f;break;case 81:for(var I=0;I<16;I++){var R=n[I];b.chIndicesInsert(this,R,l,i,6)}p+=60/m/a.resolution*(l-h),h=l,m=6e7/(65536*t[i+3]+256*t[i+4]+t[i+5]),s.push({timing:l,time:p,value:m});break;case 84:break;case 88:r.push({timing:l,value:[t[i+3],Math.pow(2,t[i+4])]})}var M=b.variableLengthToInt(t,i+2,i+2+4);i+=2+M[1]+M[0]}break;default:if(null==T)return"Irregular SMF. ("+i+" byte addr)";t[--i]=T,T=null}this.settings.isWebMIDI&&null!=T&&b.chIndicesInsert(this,n[16],l,v,i-v)}!this.settings.isSkipEnding&&o<l&&(o=l);for(var N=0;N<n.length;N++)n[N].indicesCur=n[N].indicesHead,n[N].indicesPre=n[N].indicesHead}return e.p=i,e.tempoTrack=s,e.beatTrack=r,e.songLength=o,e}function E(t){for(var i,a,n,s=this,r=t.smf,o=t.header,u=t.channels,l=t.tempoTrack,m=t.songLength,h=-1,p=-1,T=Number.MAX_SAFE_INTEGER,f=Number.MAX_SAFE_INTEGER,g=0,v=0,b=function(t){var l=u[t],m=2,b=0,y=64,A=127,V=100,k=0,I=0,R=s.settings.initReverb,M=0,N=127,w=127,O=0,P=127;i=120,a=0,n=0;for(var S=[],D=l.indicesHead,x=l.indices,E=new Array(128),W=function(){var e=this,u=x[D],W=x[D+2],L=x[D+3],q=60/i/o.resolution*(u-a)+n,B=r[W]>>4;switch(B){case 8:case 9:if(9==B&&0!=r[W+2]){var G={start:u,stop:null,startTime:q,stopTime:null,pitch:r[W+1],pitchBend:[{timing:u,time:q,value:b}],pan:[{timing:u,time:q,value:y}],expression:[{timing:u,time:q,value:A*(P/127)}],velocity:r[W+2]/127*(V/127),modulation:[{timing:u,time:q,value:k}],holdBeforeStop:null,reverb:[{timing:u,time:q,value:R}],chorus:[{timing:u,time:q,value:M}],instrument:O,channel:t,nextSameNoteOnInterval:-1,drumStopTime:2},C=E[r[W+1]];C&&(C.nextSameNoteOnInterval=q-C.startTime),E[r[W+1]]=G,S.some(function(t,i){c(this,e);var a=l.notes[t];a.pitch==r[W+1]&&null==a.stop&&(a.stop=u,a.stopTime=q,d.delete(S,i))}.bind(this)),S.push(l.notes.length),l.notes.push(G),u<T&&(T=u,f=q)}else S.some(function(t,i){c(this,e);var a=l.notes[t];if(a.pitch==r[W+1]&&null==a.stop)return I>=s.settings.holdOnValue?null==a.holdBeforeStop&&(a.holdBeforeStop=[{timing:u,time:q,value:I}]):(a.stop=u,a.stopTime=q,d.delete(S,i)),u>g&&(g=u,v=q),!0}.bind(this));break;case 10:break;case 11:switch(r[W+1]){case 1:k=r[W+2],S.forEach(function(t){c(this,e),l.notes[t].modulation.push({timing:u,time:q,value:k})}.bind(this));break;case 6:0==N&&0==w&&(m=r[W+2])>24&&(m=24);break;case 7:V=r[W+2];break;case 10:y=r[W+2],S.forEach(function(t){c(this,e),l.notes[t].pan.push({timing:u,time:q,value:y})}.bind(this));break;case 11:A=r[W+2],S.forEach(function(t){c(this,e),l.notes[t].expression.push({timing:u,time:q,value:A*(P/127)})}.bind(this));break;case 64:if((I=r[W+2])<s.settings.holdOnValue)for(var F=S.length-1;F>=0;F--){var _=S[F],j=l.notes[_];null==j.stop&&null!=j.holdBeforeStop&&(j.stop=u,j.stopTime=q,d.delete(S,F))}break;case 91:R=r[W+2],S.forEach(function(t){c(this,e),l.notes[t].reverb.push({timing:u,time:q,value:R})}.bind(this));break;case 93:M=r[W+2],S.forEach(function(t){c(this,e),l.notes[t].chorus.push({timing:u,time:q,value:M})}.bind(this));break;case 98:r[W+2];break;case 99:r[W+2];break;case 100:N=r[W+2];break;case 101:w=r[W+2];break;case 111:-1==h&&(h=u,p=q)}break;case 12:O=r[W+1];break;case 13:break;case 14:b=(128*r[W+2]+r[W+1]-8192)/8192*m,S.forEach(function(t){c(this,e),l.notes[t].pitchBend.push({timing:u,time:q,value:b})}.bind(this));break;case 15:switch(r[W]){case 240:case 247:if(127==r[W+1]&&127==r[W+2]&&4==r[W+3]&&1==r[W+4]){var z=r[W+6];z>127&&(z=127),P=z,S.forEach(function(t){c(this,e),l.notes[t].expression.push({timing:u,time:q,value:A*(P/127)})}.bind(this))}break;case 255:switch(r[W+1]){case 81:n+=60/i/o.resolution*(u-a),a=u,i=6e7/(65536*r[W+3]+256*r[W+4]+r[W+5])}}break;default:return{v:{v:"Error parseSMF. "}}}D=L};-1!=D;){var L=W();if("object"===e(L))return L.v}l.nowNoteOnIdxAry=S,s.debug||delete l.indices},y=0;y<16;y++){var A=b(y);if("object"===e(A))return A.v}for(var V=0;V<16;V++){for(var k=u[V],I=k.nowNoteOnIdxAry,R=function(e){var t=this,i=k.notes[I[e]];if(null==i.stop){i.stop=g,i.stopTime=v;["pitchBend","pan","expression","modulation","reverb","chorus"].forEach(function(e){c(this,t);for(var a=i[e],n=a.length-1;n>=1;n--){a[n].timing>g&&d.delete(a,n)}}.bind(this)),d.delete(I,e)}},M=I.length-1;M>=0;M--)R(M);delete k.nowNoteOnIdxAry}this.settings.isSkipEnding&&(m=g),l.push({timing:m,time:60/i/o.resolution*(m-a)+n,value:120});var N=[];if(this.settings.isWebMIDI)for(var w=u[16],O=120,P=0,S=0,D=w.indicesHead,x=w.indices;-1!=D;){var E=x[D],W=x[D+1],L=x[D+2],q=x[D+3],B=60/O/o.resolution*(E-P)+S;switch(r[L]){case 255:switch(r[L+1]){case 81:S+=60/O/o.resolution*(E-P),P=E,O=6e7/(65536*r[L+3]+256*r[L+4]+r[L+5])}}N.push({time:B,tick:E,smfPtr:L,smfPtrLen:W}),D=q}return t.songLength=m,t.cc111Tick=h,t.cc111Time=p,t.firstNoteOnTiming=T,t.firstNoteOnTime=f,t.lastNoteOffTiming=g,t.lastNoteOffTime=v,this.settings.isWebMIDI&&(t.messages=N,t.smfData=new Uint8Array(r)),t}function W(e){if(this.debug){console.log(e);var t=performance.now()}var i=new Uint8Array(e);if(77!=i[0]||84!=i[1]||104!=i[2]||100!=i[3])return"Not Sandard MIDI File.";var a={};if(a.smf=i,D.call(this,a),this.debug)var n=performance.now();if(x.call(this,a),this.debug)var s=performance.now();E.call(this,a);var r={};if(r.header=a.header,r.tempoTrack=a.tempoTrack,r.beatTrack=a.beatTrack,r.channels=a.channels,r.songLength=a.songLength,r.cc111Tick=a.cc111Tick,r.cc111Time=a.cc111Time,r.firstNoteOnTiming=a.firstNoteOnTiming,r.firstNoteOnTime=a.firstNoteOnTime,r.lastNoteOffTiming=a.lastNoteOffTiming,r.lastNoteOffTime=a.lastNoteOffTime,this.settings.isWebMIDI&&(r.messages=a.messages,r.smfData=new Uint8Array(i)),this.debug){var o=performance.now();console.log("parseSMF time",o-t),console.log("parseSMF(0/2) time",n-t),console.log("parseSMF(1/2) time",s-n),console.log("parseSMF(2/2) time",o-s),console.log(r)}return r}function L(){var e=this;if(navigator.requestMIDIAccess){var t=this.settings.WebMIDIPortSysEx,i=function(i){var a=this;c(this,e);var n,s=i.outputs;return this.settings.WebMIDIPortOutputs=s,-1==this.settings.WebMIDIPort?this.settings.WebMIDIPortOutputs.forEach(function(e){c(this,a),n||(n=e)}.bind(this)):n=this.settings.WebMIDIPortOutputs.get(this.settings.WebMIDIPort),this.settings.WebMIDIPortOutput=n,this.settings.WebMIDIPortSysEx=t,n&&(n.open(),this.initStatus()),s}.bind(this),a=function(n){c(this,e),console.log(n),t&&(t=!1,navigator.requestMIDIAccess({sysex:t}).then(i).catch(a))}.bind(this);navigator.requestMIDIAccess({sysex:t}).then(i).catch(a),window.addEventListener("unload",function(){c(this,e);for(var t=0;t<16;t++){this.settings.WebMIDIPortOutput.send([176+t,120,0]);for(var i=0;i<128;i++)this.settings.WebMIDIPortOutput.send([128+t,i,0])}}.bind(this))}}return function(){function e(i){t(this,e),m.call(this,i)}return a(e,[{key:"init",value:function(e){return f.call(this,e)}},{key:"parseSMF",value:function(e){return W.call(this,e)}},{key:"setData",value:function(e){return g.call(this,e)}},{key:"play",value:function(e){return A.call(this,e)}},{key:"stop",value:function(e){return V.call(this,e)}},{key:"initStatus",value:function(e,t){return v.call(this,e,t)}},{key:"getTime",value:function(e){return P.call(this,e)}},{key:"getTiming",value:function(e){return S.call(this,e)}},{key:"createBaseNote",value:function(e,t,i,a,n){return k.call(this,e,t,i,a,n)}},{key:"createNote",value:function(e){return R.call(this,e)}},{key:"createPercussionNote",value:function(e){return M.call(this,e)}},{key:"stopAudioNode",value:function(e,t,i,a){return N.call(this,e,t,i,a)}},{key:"pushFunc",value:function(e){return w.call(this,e)}},{key:"clearFunc",value:function(e,t){return O.call(this,e,t)}},{key:"startWebMIDI",value:function(){return L.call(this)}},{key:"addEventListener",value:function(e,t){this.events.push({type:e,func:t})}},{key:"removeEventListener",value:function(e,t){for(var i=this.events.length;i>=0;i--)event.type==e&&event.func===t&&this.events.splice(i,1)}},{key:"removeAllEventListener",value:function(e){for(var t=this.events.length;t>=0;t--)event.type==e&&this.events.splice(t,1)}},{key:"fireEvent",value:function(e,t){var i=this;this.events.forEach(function(a){if(c(this,i),a.type==e)try{a.func(t)}catch(e){console.log(e)}}.bind(this))}},{key:"getChannels",value:function(){return this.channels}},{key:"setChannels",value:function(e){var t=this;e.forEach(function(e,i){c(this,t),this.channels[i]=e}.bind(this))}},{key:"initChannels",value:function(){for(var e=0;e<16;e++)this.channels[e]=[0,0,1]}},{key:"getMasterVolume",value:function(){return this.settings.masterVolume}},{key:"setMasterVolume",value:function(e){this.settings.masterVolume=e,this.isStarted&&(this.masterGainNode.gain.value=this.settings.masterVolume)}},{key:"isLoop",value:function(){return this.settings.loop}},{key:"setLoop",value:function(e){this.settings.loop=e}},{key:"isWebMIDI",value:function(){return this.settings.isWebMIDI}},{key:"setWebMIDI",value:function(e){this.settings.isWebMIDI=e}},{key:"isCC111",value:function(){return this.settings.isCC111}},{key:"setCC111",value:function(e){this.settings.isCC111=e}},{key:"setStartTime",value:function(e){this.states.startTime-=e}},{key:"setOnSongEndListener",value:function(e){this.onSongEndListener=e}},{key:"onSongEnd",value:function(){if(this.onSongEndListener&&this.onSongEndListener())return;this.settings.loop&&(this.initStatus(!0),this.settings.isCC111&&-1!=this.cc111Time&&this.setStartTime(this.cc111Time),this.play(!0))}},{key:"isReverb",value:function(){return this.settings.isReverb}},{key:"setReverb",value:function(e){this.settings.isReverb=e}},{key:"getReverbVolume",value:function(){return this.settings.reverbVolume}},{key:"setReverbVolume",value:function(e){this.settings.reverbVolume=e}},{key:"isChorus",value:function(){return this.settings.isChorus}},{key:"setChorus",value:function(e){this.settings.isChorus=e}},{key:"getChorusVolume",value:function(){return this.settings.chorusVolume}},{key:"setChorusVolume",value:function(e){this.settings.chorusVolume=e}}]),e}()}));
